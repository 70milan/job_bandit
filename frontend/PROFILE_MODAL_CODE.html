<!-- 
  PROFILE MODAL - ADD TO index.html
  
  INSTRUCTIONS:
  1. Add the Profile button to line 260 (after the Generate button):
     <button id="btn-profile" class="btn">ðŸ‘¤ Profile</button>
     
  2. Add this entire modal HTML BEFORE the closing </body> tag
  
  3. Add the JavaScript code at the END of the existing <script> section
-->

<!-- MODAL CSS - Add to <style> section -->
<style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal.open {
        display: flex;
    }

    .modal-card {
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-card textarea {
        width: 100%;
        height: 120px;
        background: #1a1a1a;
        color: #eaeaea;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 8px;
        font-family: monospace;
        font-size: 13px;
        resize: vertical;
    }

    .modal-card input[type="file"] {
        width: 100%;
        padding: 8px;
        background: #1a1a1a;
        color: #eaeaea;
        border: 1px solid #444;
        border-radius: 4px;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        justify-content: flex-end;
    }

    .modal-actions .btn {
        flex: 0 0 auto;
        min-width: 80px;
    }
</style>

<!-- MODAL HTML - Add before </body> -->
<div id="profile-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong style="font-size:14px">Edit Profile</strong>
            <span id="profile-status" style="font-size:12px;color:#9aa;"> </span>
        </div>
        <div style="display:flex;gap:8px;flex-direction:column;margin-top:10px;">
            <label style="font-size:13px">Profile JSON</label>
            <textarea id="profile-textarea" placeholder='{"name":"Your Name","summary":"..."}'></textarea>

            <label style="font-size:13px">Job Description (paste the JD you're applying to)</label>
            <textarea id="profile-jobdesc" placeholder="Paste job description here"></textarea>

            <label style="font-size:13px">Upload resume (.docx)</label>
            <input id="profile-resume-file" type="file" accept=".docx" />
        </div>
        <div class="modal-actions">
            <button id="profile-cancel" class="btn">Cancel</button>
            <button id="profile-save" class="btn" style="background:#28a745;color:#fff">Save</button>
        </div>
    </div>
</div>

<!-- JAVASCRIPT - Add at the END of existing <script> section -->
<script>
    // Profile Modal Code - Add this AT THE END of the existing script section

    const btnProfile = document.getElementById('btn-profile');
    const profileModal = document.getElementById('profile-modal');
    const profileTextarea = document.getElementById('profile-textarea');
    const profileSaveBtn = document.getElementById('profile-save');
    const profileCancelBtn = document.getElementById('profile-cancel');
    const profileStatus = document.getElementById('profile-status');

    function openProfileModal() {
        profileModal.classList.add('open');
        profileModal.setAttribute('aria-hidden', 'false');
        profileTextarea.focus();
    }

    function closeProfileModal() {
        profileModal.classList.remove('open');
        profileModal.setAttribute('aria-hidden', 'true');
        profileStatus.innerText = '';
    }

    async function loadProfileToModal() {
        try {
            profileStatus.innerText = 'Loading...';
            const res = await fetch('http://127.0.0.1:5050/profile');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const profile = await res.json();

            // Don't show resume_text in the textarea (too big)
            const profileWithoutResume = { ...profile };
            delete profileWithoutResume.resume_text;
            profileTextarea.value = JSON.stringify(profileWithoutResume, null, 2);

            // populate job description
            const jobDescElem = document.getElementById('profile-jobdesc');
            const fileInput = document.getElementById('profile-resume-file');
            if (jobDescElem) jobDescElem.value = (profile && profile.job_description) ? profile.job_description : '';
            if (fileInput) fileInput.value = null;
            profileStatus.innerText = '';
            openProfileModal();
        } catch (e) {
            console.error('Profile Error:', e);
            alert('Profile error: ' + e.message + '\nEnsure backend is running on port 5050.');
            profileStatus.innerText = '';
        }
    }

    btnProfile.onclick = () => loadProfileToModal();
    profileCancelBtn.onclick = () => closeProfileModal();

    profileSaveBtn.onclick = async () => {
        try {
            profileStatus.innerText = 'Saving...';
            let parsed;
            try {
                parsed = JSON.parse(profileTextarea.value);
            } catch (e) {
                profileStatus.innerText = 'Invalid JSON';
                alert('Invalid JSON: ' + e.message);
                return;
            }

            // attach job description from the modal
            const jobDescElem = document.getElementById('profile-jobdesc');
            if (jobDescElem) parsed.job_description = jobDescElem.value || '';

            // if a resume file was chosen, upload it first
            const fileInput = document.getElementById('profile-resume-file');
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const fd = new FormData();
                fd.append('file', fileInput.files[0]);
                profileStatus.innerText = 'Uploading resume...';
                try {
                    const upRes = await fetch('http://127.0.0.1:5050/profile/resume', { method: 'POST', body: fd });
                    const upJson = await upRes.json();
                    console.log('Resume upload response:', upJson);
                    if (upJson.status !== 'ok') {
                        profileStatus.innerText = 'Resume upload failed: ' + (upJson.error || 'unknown error');
                        alert('Resume upload failed: ' + JSON.stringify(upJson));
                        return;
                    }
                    profileStatus.innerText = 'Resume uploaded!';

                    // CRITICAL: Re-fetch profile to get updated resume_text
                    const refreshRes = await fetch('http://127.0.0.1:5050/profile');
                    const refreshedProfile = await refreshRes.json();
                    parsed.resume_text = refreshedProfile.resume_text || '';
                    console.log('Resume preserved - length:', parsed.resume_text.length);
                } catch (upErr) {
                    console.error('Resume upload error:', upErr);
                    profileStatus.innerText = 'Resume upload error: ' + upErr.message;
                    alert('Resume upload error: ' + upErr.message);
                    return;
                }
            }

            const saveRes = await fetch('http://127.0.0.1:5050/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(parsed)
            });
            const saveJson = await saveRes.json();
            if (saveJson.status === 'ok') {
                profileStatus.innerText = 'Saved';
                setTimeout(() => closeProfileModal(), 600);
            } else {
                profileStatus.innerText = 'Save failed';
                alert('Save failed: ' + JSON.stringify(saveJson));
            }
        } catch (e) {
            console.error('Profile Save Error:', e);
            alert('Profile save error: ' + e.message);
            profileStatus.innerText = '';
        }
    };

    // Close modal on ESC
    window.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape' && profileModal.classList.contains('open')) {
            closeProfileModal();
        }
    });

</script>